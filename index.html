<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…ÙˆÙ„Ø¯Ø§Øª ÙˆØ§Ù„Ù…ØµØ§Ø±ÙŠÙ - Ø¥ØµØ¯Ø§Ø± Ù…Ø·ÙˆÙ‘Ø±</title>

  <style>
    :root{
      --bg:#f4f5f7;
      --card:#ffffff;
      --border:#e5e7eb;
      --muted:#6b7280;
      --primary:#111827;
      --safe:#22c55e;
      --soon:#f97316;
      --due:#ef4444;
      --radius:14px;
    }

    *{box-sizing:border-box;font-family:system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif}

    body{
      margin:0;
      background:var(--bg);
      color:#111827;
    }

    /* Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
    .login-wrap{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background:var(--bg);
      padding:16px;
    }
    .login-card{
      background:#fff;
      border-radius:var(--radius);
      padding:22px 20px 20px;
      max-width:360px;
      width:100%;
      border:1px solid var(--border);
      box-shadow:0 10px 25px rgba(15,23,42,.12);
    }
    .login-card h2{
      margin:0 0 4px;
      font-size:18px;
    }
    .login-card p{
      margin:0 0 14px;
      font-size:12px;
      color:var(--muted);
    }
    #login-error{
      margin-top:8px;
      font-size:12px;
      color:#b91c1c;
      display:none;
    }
    .logout-btn{
      font-size:11px;
      padding:5px 10px;
    }

    header{
      position:sticky;
      top:0;
      z-index:20;
      background:#fff;
      border-bottom:1px solid var(--border);
      padding:12px 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    header h1{
      margin:0;
      font-size:18px;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    header h1 span{
      font-size:11px;
      color:var(--muted);
      font-weight:400;
    }

    .header-actions{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }

    button{
      border-radius:999px;
      border:1px solid var(--border);
      padding:8px 14px;
      background:#fff;
      cursor:pointer;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    button:hover{
      background:#f9fafb;
    }
    .btn-primary{
      background:var(--primary);
      color:#fff;
      border-color:var(--primary);
    }
    .btn-primary:hover{
      background:#020617;
    }
    .btn-danger{
      color:#b91c1c;
      border-color:#fecaca;
      background:#fef2f2;
    }

    main{
      padding:16px 20px 40px;
      display:grid;
      grid-template-columns:320px minmax(0, 2.2fr) minmax(0, 1.6fr);
      gap:16px;
    }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      border:1px solid var(--border);
      padding:14px 14px 16px;
      box-shadow:0 1px 0 rgba(15,23,42,.03);
    }
    .card h2{
      margin:0 0 10px;
      font-size:15px;
    }
    .card h3{
      margin:12px 0 8px;
      font-size:14px;
    }

    label{
      font-size:12px;
      color:#374151;
      font-weight:600;
    }
    label small{
      font-weight:400;
      color:var(--muted);
    }

    input, select{
      width:100%;
      padding:9px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      font-size:13px;
      margin-top:4px;
      background:#fff;
      transition:border-color .15s, box-shadow .15s;
    }
    input:focus, select:focus{
      outline:none;
      border-color:#94a3b8;
      box-shadow:0 0 0 3px rgba(148,163,184,.28);
    }

    .field{
      display:flex;
      flex-direction:column;
      margin-bottom:8px;
    }

    .gen-list{
      list-style:none;
      padding:0;
      margin:8px 0 0;
      max-height:420px;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .gen-item{
      border-radius:12px;
      border:1px solid var(--border);
      padding:8px 10px;
      cursor:pointer;
      background:#fff;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .gen-item.active{
      border-color:#4b5563;
      box-shadow:0 0 0 2px rgba(148,163,184,.35);
      background:#f9fafb;
    }
    .gen-item-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
    }
    .gen-name{
      font-size:13px;
      font-weight:600;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .gen-meta{
      font-size:11px;
      color:var(--muted);
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }
    .status-pill{
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      border:1px solid var(--border);
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .status-safe{background:#ecfdf5;color:#166534;border-color:#bbf7d0}
    .status-soon{background:#fffbeb;color:#92400e;border-color:#fed7aa}
    .status-due{background:#fef2f2;color:#b91c1c;border-color:#fecaca}

    .pill{
      padding:2px 8px;
      border-radius:999px;
      border:1px dashed #e5e7eb;
      font-size:11px;
      color:var(--muted);
    }

    .metrics{
      display:grid;
      grid-template-columns:repeat(4, minmax(0,1fr));
      gap:8px;
      margin:8px 0 12px;
    }
    .metric{
      border-radius:12px;
      border:1px dashed #e5e7eb;
      padding:8px 10px;
      background:#f9fafb;
    }
    .metric-label{
      font-size:11px;
      color:var(--muted);
    }
    .metric-value{
      margin-top:3px;
      font-size:16px;
      font-weight:700;
    }

    .progress-wrap{
      margin:8px 0 0;
    }
    .progress-label{
      font-size:11px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
    }
    .progress-bar-out{
      margin-top:4px;
      width:100%;
      height:10px;
      border-radius:999px;
      background:#e5e7eb;
      overflow:hidden;
    }
    .progress-bar-in{
      height:100%;
      width:0%;
      background:var(--safe);
      transition:width .25s;
    }
    .progress-bar-in.soon{background:var(--soon)}
    .progress-bar-in.due{background:var(--due)}

    .detail-grid{
      display:grid;
      grid-template-columns:repeat(3, minmax(0,1fr));
      gap:10px;
      margin-bottom:12px;
    }

    .row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      justify-content:space-between;
    }

    .add-reading-grid{
      display:grid;
      grid-template-columns:repeat(3, minmax(0,1fr));
      gap:10px;
      margin-top:8px;
      align-items:end;
    }

    .err{
      margin-top:8px;
      background:#fef2f2;
      color:#b91c1c;
      padding:6px 8px;
      font-size:12px;
      border-radius:10px;
      border:1px solid #fecaca;
    }

    .table-wrap{
      border-radius:12px;
      border:1px solid var(--border);
      overflow:auto;
      max-height:360px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      background:#fff;
    }
    thead{
      background:#f9fafb;
      position:sticky;
      top:0;
      z-index:5;
    }
    th, td{
      padding:6px 8px;
      border-top:1px solid #e5e7eb;
      text-align:right;
      vertical-align:middle;
      white-space:nowrap;
    }
    tr.soon-row{background:#fff7ed}
    tr.due-row{background:#fef2f2}
    td.actions{
      display:flex;
      gap:4px;
      align-items:center;
      justify-content:flex-start;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:1px 6px;
      border-radius:999px;
      border:1px solid #e5e7eb;
      font-size:11px;
    }

    .tab-header{
      display:flex;
      gap:6px;
      border-bottom:1px solid #e5e7eb;
      margin-bottom:10px;
    }
    .tab-btn{
      border-radius:999px;
      border:none;
      background:transparent;
      padding:6px 10px;
      font-size:13px;
      cursor:pointer;
      color:var(--muted);
    }
    .tab-btn.active{
      background:#111827;
      color:#fff;
    }

    .filters{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-bottom:8px;
      align-items:flex-end;
    }
    .filters .field{
      margin-bottom:0;
    }
    .filters .field input{
      min-width:150px;
    }

    .muted{
      color:var(--muted);
      font-size:12px;
    }

    /* Ø´Ø¨ÙƒØ© Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø·Ø§Ø±Ø¦Ø© */
    .emergency-grid{
      display:grid;
      grid-template-columns:repeat(3, minmax(0,1fr));
      gap:10px;
      margin-top:8px;
      align-items:end;
    }

    @media (max-width:1150px){
      main{
        grid-template-columns:280px minmax(0, 2fr);
        grid-template-areas:
          "a b"
          "a c";
      }
      .panel-left{grid-area:a}
      .panel-center{grid-area:b}
      .panel-right{grid-area:c}
    }

    @media (max-width:900px){
      main{
        grid-template-columns:1fr;
        grid-template-areas:
          "a"
          "b"
          "c";
      }
    }

    @media (max-width:900px){
      .emergency-grid{
        grid-template-columns:1fr;
      }
    }
  </style>
</head>
<body>

  <!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <div id="login-screen" class="login-wrap">
    <form id="login-form" class="login-card">
      <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
      <p>Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù….</p>
      <div class="field">
        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
        <input id="login-username" autocomplete="username" placeholder="Admin">
      </div>
      <div class="field">
        <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
        <input id="login-password" type="password" autocomplete="current-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢">
      </div>
      <button class="btn-primary" type="submit" style="width:100%;margin-top:6px;">Ø¯Ø®ÙˆÙ„</button>
      <div id="login-error"></div>
      <p style="margin-top:10px;font-size:11px;color:#6b7280;">
        Nafithat-Al-Amal
      </p>
    </form>
  </div>

  <!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
  <div id="app" style="display:none;">
    <header>
      <h1>
        Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø³Ø§Ø¹Ø§Øª ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙˆÙ„Ø¯Ø§Øª ÙˆØ§Ù„Ù…ØµØ§Ø±ÙŠÙ
        <span>Nafithat Al-Amal</span>
      </h1>
      <div class="header-actions">
        <button id="export-json">ØªØµØ¯ÙŠØ± JSON</button>

        <label id="import-json-wrapper" style="font-size:12px;display:inline-flex;align-items:center;gap:6px;cursor:pointer;">
          Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON
          <input type="file" id="import-json" accept="application/json" style="display:none">
        </label>

        <button id="save-local">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        <button id="export-csv" title="Ù…Ù„Ø®Øµ CSV Ø¨Ø³ÙŠØ· Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆÙ„Ø¯Ø§Øª">Ù…Ù„Ø®Øµ CSV</button>

        <span class="muted">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: <strong id="current-user-label">-</strong></span>
        <button id="logout-btn" class="logout-btn">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
      </div>
    </header>

    <main>
      <!-- Ù„ÙˆØ­ Ø§Ù„Ù…ÙˆÙ„Ø¯Ø§Øª -->
      <section class="card panel-left">
        <h2>Ø§Ù„Ù…ÙˆÙ„Ø¯Ø§Øª</h2>
        <div class="field">
          <label>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ„Ø¯ <small>(Ø³ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©)</small></label>
          <input id="gen-name" placeholder="Ù…Ø«Ø§Ù„: Perkins 250 KVA-1">
        </div>
        <div class="field">
          <label>Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø© (Ø³Ø§Ø¹Ø©)</label>
          <input id="gen-smr" type="number" min="0" step="1" placeholder="Ù…Ø«Ø§Ù„: 2000">
        </div>
        <div class="field">
          <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©</label>
          <input id="gen-date" type="date">
        </div>
        <button class="btn-primary" id="add-gen" style="width:100%;margin-top:6px;">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆÙ„Ø¯</button>

        <div class="row" style="margin-top:10px;">
          <span class="muted">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆÙ„Ø¯Ø§Øª</span>
          <button id="delete-gen" class="btn-danger" style="font-size:11px;padding:5px 9px;">Ø­Ø°Ù Ø§Ù„Ù…ÙˆÙ„Ø¯ Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
        </div>

        <ul id="gen-list" class="gen-list"></ul>
      </section>

      <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆÙ„Ø¯ -->
      <section class="card panel-center">
        <div class="row">
          <h2 style="margin:0;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆÙ„Ø¯</h2>
          <span id="detail-name-pill" class="pill">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆÙ„Ø¯ Ù…Ø­Ø¯Ø¯ Ø¨Ø¹Ø¯</span>
        </div>

        <div class="detail-grid">
          <div class="field">
            <label>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ„Ø¯</label>
            <input id="d-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ„Ø¯">
          </div>
          <div class="field">
            <label>Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø© (SMR)</label>
            <input id="d-smr" type="number" min="0" step="1">
          </div>
          <div class="field">
            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©</label>
            <input id="d-date" type="date">
          </div>
        </div>

        <div class="metrics">
          <div class="metric">
            <div class="metric-label">Ø¢Ø®Ø± Ù‚Ø±Ø§Ø¡Ø© Ø¹Ø¯Ø§Ø¯</div>
            <div class="metric-value" id="m-current">-</div>
          </div>
          <div class="metric">
            <div class="metric-label">Ø³Ø§Ø¹Ø§Øª Ø¢Ø®Ø± ÙØªØ±Ø©</div>
            <div class="metric-value" id="m-weekly">-</div>
          </div>
          <div class="metric">
            <div class="metric-label">Ø³Ø§Ø¹Ø§Øª Ù…Ù†Ø° Ø¢Ø®Ø± Ø®Ø¯Ù…Ø©</div>
            <div class="metric-value" id="m-since">-</div>
          </div>
          <div class="metric">
            <div class="metric-label">Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ø§Ù„ØªØ§Ù„ÙŠ (Ø³Ø§Ø¹Ø©)</div>
            <div class="metric-value" id="m-next">-</div>
          </div>
        </div>

        <div class="progress-wrap">
          <div class="progress-label">
            <span>Ù†Ø³Ø¨Ø© Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø¯ÙˆØ±Ø© Ø§Ù„Ù€ 200 Ø³Ø§Ø¹Ø©</span>
            <span id="m-percent" class="muted">0%</span>
          </div>
          <div class="progress-bar-out">
            <div id="m-bar" class="progress-bar-in"></div>
          </div>
        </div>

        <h3>Ø¥Ø¶Ø§ÙØ© Ù‚Ø±Ø§Ø¡Ø© Ø¹Ø¯Ø§Ø¯</h3>
        <div class="add-reading-grid">
          <div class="field">
            <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
            <input id="r-date" type="date">
          </div>
          <div class="field">
            <label>Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯</label>
            <input id="r-meter" type="number" min="0" step="1">
          </div>
          <div class="field">
            <button class="btn-primary" id="add-reading">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</button>
          </div>
        </div>
        <div id="r-err" class="err" style="display:none;"></div>

        <h3 style="margin-top:14px;">Ø³Ø¬Ù„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª / Ø§Ù„ØµÙŠØ§Ù†Ø©</h3>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø§Ù„Ø¹Ø¯Ø§Ø¯</th>
                <th>Ø³Ø§Ø¹Ø§Øª Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©</th>
                <th>Ù…Ù†Ø° Ø§Ù„Ø®Ø¯Ù…Ø©</th>
                <th>Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ø§Ù„ØªØ§Ù„ÙŠ</th>
                <th>Ø­Ø§Ù„Ø©</th>
                <th>Ù…ØµØ±ÙˆÙ Ø§Ù„Ø®Ø¯Ù…Ø©</th>
                <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody id="log-body"></tbody>
          </table>
        </div>
      </section>

      <!-- Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± + Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø·Ø§Ø±Ø¦Ø© -->
      <section class="card panel-right">
        <div class="tab-header">
          <button class="tab-btn active" data-tab="summary">Ù…Ù„Ø®Øµ</button>
          <button class="tab-btn" data-tab="overview">Ø´Ø§Ù…Ù„</button>
          <button class="tab-btn" data-tab="expenses">Ù…ØµØ§Ø±ÙŠÙ</button>
        </div>

        <div class="filters">
          <div class="field">
            <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
            <input type="date" id="rep-from">
          </div>
          <div class="field">
            <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
            <input type="date" id="rep-to">
          </div>
          <button id="rep-refresh">ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
          <button id="rep-csv">ØªØµØ¯ÙŠØ± CSV</button>
        </div>

        <div id="rep-summary" class="report-tab">
          <p class="muted" style="margin:0 0 6px;">Ù…Ù„Ø®Øµ ØªØ´ØºÙŠÙ„ ÙˆÙ…ØµØ§Ø±ÙŠÙ Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆÙ„Ø¯ Ù„Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.</p>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Ø§Ù„Ù…ÙˆÙ„Ø¯</th>
                  <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„</th>
                  <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ (IQD)</th>
                  <th>Ø¹Ø¯Ø¯ Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©</th>
                </tr>
              </thead>
              <tbody id="rep-summary-body"></tbody>
            </table>
          </div>
        </div>

        <div id="rep-overview" class="report-tab" style="display:none;">
          <p class="muted" style="margin:0 0 6px;">ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„ Ù„ÙƒÙ„ Ù…ÙˆÙ„Ø¯: ØªØ´ØºÙŠÙ„ + Ù…ØµØ§Ø±ÙŠÙ + Ù…Ø¤Ø´Ø±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.</p>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Ø§Ù„Ù…ÙˆÙ„Ø¯</th>
                  <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„</th>
                  <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ (IQD)</th>
                  <th>Ø¹Ø¯Ø¯ Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©</th>
                  <th>Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙƒÙ„ÙØ© Ù„ÙƒÙ„ Ø³Ø§Ø¹Ø©</th>
                  <th>Ø¢Ø®Ø± ØªØ§Ø±ÙŠØ® ØµÙŠØ§Ù†Ø©</th>
                </tr>
              </thead>
              <tbody id="rep-overview-body"></tbody>
            </table>
          </div>
        </div>

        <div id="rep-expenses" class="report-tab" style="display:none;">
          <p class="muted" style="margin:0 0 6px;">ØªÙØµÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…ÙˆÙ„Ø¯ ÙˆØ§Ù„Ø®Ø¯Ù…Ø©.</p>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Ø§Ù„Ù…ÙˆÙ„Ø¯</th>
                  <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø®Ø¯Ù…Ø©</th>
                  <th>Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯</th>
                  <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                  <th>Ø§Ù„Ø¹Ù…Ù„Ø©</th>
                  <th>Ù…Ù„Ø§Ø­Ø¸Ø©</th>
                </tr>
              </thead>
              <tbody id="rep-expenses-body"></tbody>
            </table>
          </div>
        </div>

        <!-- Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø·Ø§Ø±Ø¦Ø© -->
        <hr style="margin:14px 0 10px;border:none;border-top:1px solid #e5e7eb;">
        <h3 style="margin-top:0;">Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø·Ø§Ø±Ø¦Ø©</h3>

        <div class="emergency-grid">
          <div class="field">
            <label>Ù†ÙˆØ¹ Ø§Ù„Ù…ÙˆÙ„Ø¯</label>
            <select id="em-gen">
              <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆÙ„Ø¯</option>
            </select>
          </div>
          <div class="field">
            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø·Ø§Ø±Ø¦Ø©</label>
            <input id="em-date" type="date">
          </div>
          <div class="field">
            <label>ØªÙƒÙ„ÙØ© Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø·Ø§Ø±Ø¦Ø© (IQD) <small>Ù…Ø«Ø§Ù„: 150000</small></label>
            <input id="em-cost" type="number" min="0" step="1" placeholder="150000">
          </div>
          <div class="field">
            <label>Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input id="em-note" placeholder="Ù…Ø«Ø§Ù„: ØµÙŠØ§Ù†Ø© Ø¹Ø§Ø¬Ù„Ø© ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ø³ÙƒÙŠØª ÙˆØ§Ù„Ø³ÙŠØ³ØªÙ…">
          </div>
          <div class="field">
            <label style="display:inline-flex;align-items:center;gap:6px;font-weight:400;">
              <input id="em-paid" type="checkbox">
              ØªÙ… Ø¯ÙØ¹ Ø§Ù„Ù…Ø¨Ù„Øº
            </label>
          </div>
          <div class="field">
            <button id="em-add" class="btn-primary" style="width:100%;">Ø¥Ø¶Ø§ÙØ© ØµÙŠØ§Ù†Ø© Ø·Ø§Ø±Ø¦Ø©</button>
          </div>
        </div>

        <!-- Ø³Ø·Ø± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ù…Ø¹ Ù…Ø¯ÙÙˆØ¹ / ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹ -->
        <div class="row" style="margin-top:8px;justify-content:flex-start;">
          <span class="muted">
            Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø·Ø§Ø±Ø¦Ø©: <strong id="em-total">0</strong> IQD
            &nbsp;|&nbsp;
            Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø¯ÙÙˆØ¹: <strong id="em-total-paid">0</strong> IQD
            &nbsp;|&nbsp;
            Ù…Ø¬Ù…ÙˆØ¹ ØºÙŠØ± Ø§Ù„Ù…Ø¯ÙÙˆØ¹: <strong id="em-total-unpaid">0</strong> IQD
          </span>
        </div>

        <div class="table-wrap" style="margin-top:10px;max-height:220px;">
          <table>
            <thead>
              <tr>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ù†ÙˆØ¹ Ø§Ù„Ù…ÙˆÙ„Ø¯</th>
                <th>Ø§Ù„Ù…Ø¨Ù„Øº (IQD)</th>
                <th>Ù…Ù„Ø§Ø­Ø¸Ø©</th>
                <th>ØªÙ… Ø§Ù„Ø¯ÙØ¹</th>
                <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody id="em-body"></tbody>
          </table>
        </div>

      </section>
    </main>
  </div>

  <script>
    // ====== Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø© ======
    let state = { generators: [] };
    let emergencyMaintenances = [];   // Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø·Ø§Ø±Ø¦Ø©
    let selectedId = null;
    const LOCAL_KEY = "generatorSystemData_v1";

    // ğŸ”§ Ù…ÙØªØ§Ø­ ØªØ®Ø²ÙŠÙ† Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­
    const USER_STORAGE_KEY = "generatorSystemUser_v1";

    // ====== Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ======
    const USERS = [
      {username:"Sameer", password:"Sameer1234", role:"admin"},
      {username:"Jabbar", password:"1234", role:"user"}
    ];
    let currentUser = null;

    // ====== DOM helper ======
    const $ = (id) => document.getElementById(id);

    // Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¯Ø®ÙˆÙ„
    const loginScreen = $("login-screen");
    const appRoot = $("app");
    const loginForm = $("login-form");
    const loginUserInput = $("login-username");
    const loginPassInput = $("login-password");
    const loginError = $("login-error");
    const currentUserLabel = $("current-user-label");
    const logoutBtn = $("logout-btn");

    // Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù†Ø¸Ø§Ù…
    const genName   = $("gen-name");
    const genSmr    = $("gen-smr");
    const genDate   = $("gen-date");
    const addGenBtn = $("add-gen");
    const genList   = $("gen-list");
    const deleteGenBtn = $("delete-gen");

    const dName = $("d-name");
    const dSmr  = $("d-smr");
    const dDate = $("d-date");
    const detailNamePill = $("detail-name-pill");

    const mCurrent = $("m-current");
    const mWeekly  = $("m-weekly");
    const mSince   = $("m-since");
    const mNext    = $("m-next");
    const mPercent = $("m-percent");
    const mBar     = $("m-bar");

    const rDate = $("r-date");
    const rMeter = $("r-meter");
    const addReadingBtn = $("add-reading");
    const rErr = $("r-err");
    const logBody = $("log-body");

    const repFrom = $("rep-from");
    const repTo   = $("rep-to");
    const repRefresh = $("rep-refresh");
    const repCSV  = $("rep-csv");
    const repSummaryBody = $("rep-summary-body");
    const repOverviewBody = $("rep-overview-body");
    const repExpensesBody = $("rep-expenses-body");

    const expJSON = $("export-json");
    const impJSON = $("import-json");
    const importJSONWrapper = $("import-json-wrapper");
    const saveLocalBtn = $("save-local");
    const expCSV  = $("export-csv");

    // Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø·Ø§Ø±Ø¦Ø©
    const emGen  = $("em-gen");
    const emDate = $("em-date");
    const emCost = $("em-cost");
    const emNote = $("em-note");
    const emPaid = $("em-paid");
    const emAdd  = $("em-add");
    const emBody = $("em-body");
    const emTotal = $("em-total");
    const emTotalPaid = $("em-total-paid");
    const emTotalUnpaid = $("em-total-unpaid");

    // ====== ØµÙ„Ø§Ø­ÙŠØ§Øª ======
    function isAdmin(){
      return currentUser && currentUser.role === "admin";
    }

    function applyRoleUI(){
      if(!currentUser) return;
      currentUserLabel.textContent = currentUser.username + (isAdmin() ? " (Ù…Ø´Ø±Ù)" : "");
      deleteGenBtn.style.display = isAdmin() ? "" : "none";
      expJSON.style.display = isAdmin() ? "" : "none";
      importJSONWrapper.style.display = isAdmin() ? "inline-flex" : "none";
    }

    // ====== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ======
    loginForm.addEventListener("submit", (e)=>{
      e.preventDefault();
      const u = loginUserInput.value.trim();
      const p = loginPassInput.value;
      const found = USERS.find(x=>x.username===u && x.password===p);
      if(!found){
        loginError.style.display = "block";
        loginError.textContent = "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.";
        return;
      }

      currentUser = {username:found.username, role:found.role};

      // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ Ø­ØªÙ‰ Ø¨Ø¹Ø¯ Ø§Ù„Ø±ÙŠÙØ±ÙŠØ´
      localStorage.setItem(USER_STORAGE_KEY, JSON.stringify(currentUser));

      loginError.style.display = "none";
      loginScreen.style.display = "none";
      appRoot.style.display = "block";
      applyRoleUI();
    });

    // ====== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ======
    logoutBtn.addEventListener("click", ()=>{
      currentUser = null;
      // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ†
      localStorage.removeItem(USER_STORAGE_KEY);

      appRoot.style.display = "none";
      loginScreen.style.display = "flex";
      loginUserInput.value = "";
      loginPassInput.value = "";
      currentUserLabel.textContent = "-";
    });

    // ====== util ======
    function todayStr(){
      return new Date().toISOString().slice(0,10);
    }

    function byDateAsc(a,b){
      return a.date.localeCompare(b.date);
    }

    function currentMeter(gen){
      const sorted = (gen.readings||[]).slice().sort(byDateAsc);
      if(!sorted.length) return null;
      return Number(sorted[sorted.length-1].meter);
    }

    function lastWeeklyHours(gen){
      const sorted = (gen.readings||[]).slice().sort(byDateAsc);
      if(sorted.length < 2) return null;
      const last = sorted[sorted.length-1];
      const prev = sorted[sorted.length-2];
      return Number(last.meter) - Number(prev.meter);
    }

    function lastServiceInfo(gen){
      const hist = (gen.serviceHistory||[]).slice().sort(byDateAsc);
      if(hist.length){
        const last = hist[hist.length-1];
        return {date:last.date, meter:Number(last.meter)};
      }
      return {
        date: gen.lastServiceDate || null,
        meter: gen.lastServiceMeter != null ? Number(gen.lastServiceMeter) : 0
      };
    }

    function hoursSinceService(gen){
      const cm = currentMeter(gen);
      if(cm == null) return 0;
      const svc = lastServiceInfo(gen);
      return Math.max(0, cm - (svc.meter || 0));
    }

    function nextDueAt(gen){
      const svc = lastServiceInfo(gen);
      const base = svc.meter || 0;
      return base + 200;
    }

    function statusObj(gen){
      const since = hoursSinceService(gen);
      if(since >= 200) return {label:"Ù…ØªØ£Ø®Ø±Ø©", class:"status-due"};
      if(since >= 160) return {label:"Ù‚Ø±Ø¨ Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚", class:"status-soon"};
      return {label:"Ø¢Ù…Ù†Ø©", class:"status-safe"};
    }

    // ====== ØªØ·Ø¨ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø·Ø§Ø±Ø¦Ø© ======
    function normalizeEmergencyList(list){
      if(!Array.isArray(list)) return [];
      return list.map(e=>({
        id: e.id || crypto.randomUUID(),
        genId: e.genId || "",
        date: e.date || todayStr(),
        cost: e.cost != null ? Number(e.cost) : 0,
        note: e.note || "",
        paid: !!e.paid
      }));
    }

    // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆÙ„Ø¯Ø§Øª ÙÙŠ Ø­Ù‚Ù„ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø·Ø§Ø±Ø¦Ø©
    function renderEmergencyGeneratorOptions(){
      if(!emGen) return;
      emGen.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆÙ„Ø¯</option>';
      state.generators.forEach(g=>{
        const opt = document.createElement("option");
        opt.value = g.id;
        opt.textContent = g.name;
        emGen.appendChild(opt);
      });
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ (ÙƒÙ„ÙŠ / Ù…Ø¯ÙÙˆØ¹ / ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹)
    function updateEmergencyTotal(){
      if(!emTotal) return;
      let total = 0;
      let totalPaid = 0;
      let totalUnpaid = 0;

      emergencyMaintenances.forEach(item=>{
        const c = Number(item.cost);
        if(isNaN(c)) return;
        total += c;
        if(item.paid) totalPaid += c;
        else totalUnpaid += c;
      });

      emTotal.textContent = total;
      if(emTotalPaid) emTotalPaid.textContent = totalPaid;
      if(emTotalUnpaid) emTotalUnpaid.textContent = totalUnpaid;
    }

    // Ø±Ø³Ù… Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø·Ø§Ø±Ø¦Ø©
    function renderEmergencyTable(){
      if(!emBody) return;
      emBody.innerHTML = "";

      if(!emergencyMaintenances.length){
        emBody.innerHTML = "<tr><td colspan='6' class='muted'>Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙŠØ§Ù†Ø§Øª Ø·Ø§Ø±Ø¦Ø© Ù…Ø³Ø¬Ù„Ø©.</td></tr>";
        updateEmergencyTotal();
        return;
      }

      const gensById = new Map(state.generators.map(g=>[g.id,g.name]));

      emergencyMaintenances
        .slice()
        .sort((a,b)=>a.date.localeCompare(b.date))
        .forEach(item=>{
          const tr = document.createElement("tr");
          const genName = gensById.get(item.genId) || "-";
          tr.innerHTML = `
            <td>${item.date}</td>
            <td>${genName}</td>
            <td>${item.cost}</td>
            <td>${item.note || ""}</td>
            <td>${item.paid ? "âœ…" : "âŒ"}</td>
            <td class="actions">
              <button class="btn-small" data-eid="${item.id}" data-action="toggle-paid" style="font-size:11px;padding:3px 7px;">ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹</button>
              <button class="btn-small" data-eid="${item.id}" data-action="edit-em" style="font-size:11px;padding:3px 7px;">ØªØ¹Ø¯ÙŠÙ„</button>
              <button class="btn-small" data-eid="${item.id}" data-action="del-em" style="font-size:11px;padding:3px 7px;">ğŸ—‘</button>
            </td>
          `;
          emBody.appendChild(tr);
        });

      updateEmergencyTotal();
    }

    // ====== Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆÙ„Ø¯Ø§Øª ======
    function renderGenList(){
      genList.innerHTML = "";
      if(!state.generators.length){
        genList.innerHTML = "<li class='muted' style='list-style:none;padding:2px 0;'>Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ù…ÙˆÙ„Ø¯ Ø¨Ø¹Ø¯.</li>";
        renderEmergencyGeneratorOptions();
        return;
      }
      state.generators.forEach(gen=>{
        const li = document.createElement("li");
        li.className = "gen-item" + (gen.id===selectedId ? " active" : "");
        li.dataset.id = gen.id;

        const st = statusObj(gen);
        const cm = currentMeter(gen);
        const since = hoursSinceService(gen);

        li.innerHTML = `
          <div class="gen-item-header">
            <div class="gen-name" title="${gen.name}">${gen.name}</div>
            <span class="status-pill ${st.class}">
              <span style="width:8px;height:8px;border-radius:999px;background:currentColor;"></span>
              ${st.label}
            </span>
          </div>
          <div class="gen-meta">
            <span>SMR: ${gen.lastServiceMeter ?? 0}</span>
            <span>Ø¢Ø®Ø± Ù‚Ø±Ø§Ø¡Ø©: ${cm ?? "-"}</span>
            <span>Ù…Ù†Ø° Ø§Ù„Ø®Ø¯Ù…Ø©: ${since}</span>
          </div>
        `;
        genList.appendChild(li);
      });

      renderEmergencyGeneratorOptions();
    }

    // ====== Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆÙ„Ø¯ ======
    function renderDetail(){
      const gen = state.generators.find(g=>g.id===selectedId);
      if(!gen){
        detailNamePill.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆÙ„Ø¯ Ù…Ø­Ø¯Ø¯ Ø¨Ø¹Ø¯";
        dName.value = "";
        dSmr.value = "";
        dDate.value = "";
        mCurrent.textContent = "-";
        mWeekly.textContent  = "-";
        mSince.textContent   = "-";
        mNext.textContent    = "-";
        mPercent.textContent = "0%";
        mBar.style.width = "0%";
        mBar.className = "progress-bar-in";
        logBody.innerHTML = "";
        return;
      }

      detailNamePill.textContent = gen.name;
      dName.value = gen.name || "";
      dSmr.value  = gen.lastServiceMeter != null ? gen.lastServiceMeter : "";
      dDate.value = gen.lastServiceDate || "";

      const cm = currentMeter(gen);
      const weekly = lastWeeklyHours(gen);
      const since = hoursSinceService(gen);
      const next  = nextDueAt(gen);

      mCurrent.textContent = cm != null ? cm : "-";
      mWeekly.textContent  = weekly != null ? weekly : "-";
      mSince.textContent   = since;
      mNext.textContent    = next;

      const p = Math.min(100, Math.floor((since/200)*100));
      mPercent.textContent = p + "%";
      mBar.style.width = p + "%";
      mBar.className = "progress-bar-in";
      if(since >= 200) mBar.classList.add("due");
      else if(since >= 160) mBar.classList.add("soon");

      renderLog(gen);
    }

    // ====== Ø³Ø¬Ù„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª ======
    function renderLog(gen){
      logBody.innerHTML = "";
      const readings = (gen.readings||[]).slice().sort(byDateAsc);

      function baselineForDate(dateStr){
        const hist = (gen.serviceHistory||[]).slice().sort(byDateAsc);
        let base = null;
        for(const h of hist){
          if(h.date <= dateStr) base = h;
          else break;
        }
        if(base) return Number(base.meter);
        const baseInfo = lastServiceInfo(gen);
        if(baseInfo.date && baseInfo.date <= dateStr) return Number(baseInfo.meter || 0);
        return Number(baseInfo.meter || 0);
      }

      readings.forEach((r, idx)=>{
        const svc = (gen.serviceHistory||[]).find(h=>h.date===r.date && Number(h.meter)===Number(r.meter));
        const base = baselineForDate(r.date);
        const since = Math.max(0, Number(r.meter) - base);
        const next = base + 200;
        const prev = readings[idx-1];
        const weekly = prev ? (Number(r.meter) - Number(prev.meter)) : "";

        const tr = document.createElement("tr");
        const st = since >= 200 ? "due-row" : (since>=160 ? "soon-row" : "");
        if(st) tr.classList.add(st);

        const costTxt = svc && svc.cost != null ? `${svc.cost} ${svc.currency || ""}` : "-";
        const noteTxt = svc && svc.costNote ? svc.costNote : "";

        tr.innerHTML = `
          <td>${r.date}</td>
          <td>${r.meter}</td>
          <td>${weekly}</td>
          <td>${since}</td>
          <td>${next}</td>
          <td>${svc ? "<span class='chip'>Ø®Ø¯Ù…Ø© Ù…ÙƒØªÙ…Ù„Ø©</span>" : ""}</td>
          <td>${costTxt}${noteTxt ? "<br><span class='muted'>"+noteTxt+"</span>" : ""}</td>
          <td class="actions">
            <button class="btn-small" data-action="mark" data-date="${r.date}" data-meter="${r.meter}" style="font-size:11px;padding:3px 7px;">ğŸ”§ Ø®Ø¯Ù…Ø©</button>
            <button class="btn-small" data-action="expense" data-date="${r.date}" data-meter="${r.meter}" style="font-size:11px;padding:3px 7px;">ğŸ’° Ù…ØµØ±ÙˆÙ</button>
            <button class="btn-small" data-action="del" data-date="${r.date}" data-meter="${r.meter}" style="font-size:11px;padding:3px 7px;">ğŸ—‘</button>
          </td>
        `;
        logBody.appendChild(tr);
      });

      if(!readings.length){
        logBody.innerHTML = "<tr><td colspan='8' class='muted'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø±Ø§Ø¡Ø§Øª Ø¨Ø¹Ø¯ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆÙ„Ø¯.</td></tr>";
      }
    }

    // ====== Ø±Ø³Ø§Ø¦Ù„ Ø®Ø·Ø£ Ø¨Ø³ÙŠØ·Ø© ======
    function showError(el, msg){
      el.textContent = msg;
      el.style.display = "block";
    }
    function hideError(el){
      el.style.display = "none";
      el.textContent = "";
    }

    // ====== Ø¥Ø¶Ø§ÙØ© Ù…ÙˆÙ„Ø¯ (Ø£Ø¯Ù…Ù† ÙÙ‚Ø·) ======
    addGenBtn.addEventListener("click", ()=>{
      if(!isAdmin()){
        alert("Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆÙ„Ø¯Ø§Øª Ù…ØªØ§Ø­Ø© Ù„Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø·.");
        return;
      }
      if(!genName.value.trim() || !genSmr.value || !genDate.value){
        alert("Ø±Ø¬Ø§Ø¡Ù‹ Ø£ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆÙ„Ø¯ (Ø§Ù„Ø§Ø³Ù… - Ø§Ù„Ø¹Ø¯Ø§Ø¯ - Ø§Ù„ØªØ§Ø±ÙŠØ®).");
        return;
      }
      const g = {
        id: crypto.randomUUID(),
        name: genName.value.trim(),
        lastServiceMeter: Number(genSmr.value),
        lastServiceDate: genDate.value,
        readings: [],
        serviceHistory: []
      };
      state.generators.unshift(g);
      selectedId = g.id;

      genName.value = "";
      genSmr.value  = "";
      genDate.value = todayStr();

      renderGenList();
      renderDetail();
      buildReports();
      renderEmergencyTable();
    });

    // ====== Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆÙ„Ø¯ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ======
    genList.addEventListener("click",(e)=>{
      const li = e.target.closest(".gen-item");
      if(!li) return;
      selectedId = li.dataset.id;
      renderGenList();
      renderDetail();
      buildReports();
    });

    // ====== Ø­Ø°Ù Ù…ÙˆÙ„Ø¯ (Ø£Ø¯Ù…Ù† ÙÙ‚Ø·) ======
    deleteGenBtn.addEventListener("click", ()=>{
      if(!isAdmin()){
        alert("Ø­Ø°Ù Ø§Ù„Ù…ÙˆÙ„Ø¯Ø§Øª Ù…ØªØ§Ø­ Ù„Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø·.");
        return;
      }
      const gen = state.generators.find(g=>g.id===selectedId);
      if(!gen){
        alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆÙ„Ø¯ Ù…Ø­Ø¯Ø¯.");
        return;
      }
      if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆÙ„Ø¯ Ø¨ÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ Ø¨Ø§Ù„ØªØ£ÙƒÙŠØ¯ØŸ")) return;
      state.generators = state.generators.filter(g=>g.id!==selectedId);
      emergencyMaintenances = emergencyMaintenances.filter(e=>e.genId !== gen.id);
      selectedId = state.generators[0]?.id || null;
      renderGenList();
      renderDetail();
      buildReports();
      renderEmergencyTable();
    });

    // ====== ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆÙ„Ø¯ Ù…Ù† Ø§Ù„ØªÙØ§ØµÙŠÙ„ ======
    dName.addEventListener("change", ()=>{
      const gen = state.generators.find(g=>g.id===selectedId);
      if(!gen) return;
      gen.name = dName.value.trim();
      renderGenList();
      renderDetail();
      buildReports();
      renderEmergencyTable();
    });
    dSmr.addEventListener("change", ()=>{
      const gen = state.generators.find(g=>g.id===selectedId);
      if(!gen) return;
      gen.lastServiceMeter = Number(dSmr.value||0);
      renderGenList();
      renderDetail();
      buildReports();
    });
    dDate.addEventListener("change", ()=>{
      const gen = state.generators.find(g=>g.id===selectedId);
      if(!gen) return;
      gen.lastServiceDate = dDate.value;
      renderGenList();
      renderDetail();
      buildReports();
    });

    // ====== Ø¥Ø¶Ø§ÙØ© Ù‚Ø±Ø§Ø¡Ø© ======
    addReadingBtn.addEventListener("click", ()=>{
      const gen = state.generators.find(g=>g.id===selectedId);
      if(!gen){
        showError(rErr,"Ø±Ø¬Ø§Ø¡Ù‹ Ø§Ø®ØªØ± Ù…ÙˆÙ„Ø¯ Ø£ÙˆÙ„Ø§Ù‹.");
        return;
      }
      const d = rDate.value;
      const m = Number(rMeter.value);
      if(!d || isNaN(m)){
        showError(rErr,"Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø¹Ø¯Ø§Ø¯ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.");
        return;
      }
      hideError(rErr);

      const exists = (gen.readings||[]).some(x=>x.date===d && Number(x.meter)===m);
      if(exists){
        showError(rErr,"Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„.");
        return;
      }

      gen.readings = (gen.readings||[]).concat([{date:d, meter:m}]).sort(byDateAsc);
      rDate.value = "";
      rMeter.value = "";
      renderGenList();
      renderDetail();
      buildReports();
    });

    // ====== Ø¥Ø¶Ø§ÙØ© ØµÙŠØ§Ù†Ø© Ø·Ø§Ø±Ø¦Ø© ======
    emAdd.addEventListener("click", ()=>{
      const genId = emGen.value;
      const date  = emDate.value;
      const cost  = Number(emCost.value || 0);
      const note  = emNote.value.trim();
      const paid  = emPaid.checked;

      if(!genId){
        alert("Ø±Ø¬Ø§Ø¡Ù‹ Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…ÙˆÙ„Ø¯.");
        return;
      }
      if(!date){
        alert("Ø±Ø¬Ø§Ø¡Ù‹ Ø£Ø¯Ø®Ù„ ØªØ§Ø±ÙŠØ® Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø·Ø§Ø±Ø¦Ø©.");
        return;
      }
      if(isNaN(cost) || cost <= 0){
        alert("Ø±Ø¬Ø§Ø¡Ù‹ Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­ Ù„Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø·Ø§Ø±Ø¦Ø©.");
        return;
      }

      emergencyMaintenances.push({
        id: crypto.randomUUID(),
        genId,
        date,
        cost,
        note,
        paid
      });

      emDate.value = "";
      emCost.value = "";
      emNote.value = "";
      emPaid.checked = false;

      renderEmergencyTable();
    });

    // ====== Ø£Ø­Ø¯Ø§Ø« Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø·Ø§Ø±Ø¦Ø© ======
    emBody.addEventListener("click",(e)=>{
      const btn = e.target.closest("button[data-action]");
      if(!btn) return;
      const id = btn.dataset.eid;
      const action = btn.dataset.action;
      const item = emergencyMaintenances.find(x=>x.id===id);
      if(!item) return;

      if(action === "toggle-paid"){
        item.paid = !item.paid;
      }

      if(action === "edit-em"){
        if(!isAdmin()){
          alert("ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø·Ø§Ø±Ø¦Ø© Ù…ØªØ§Ø­ Ù„Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø·.");
          return;
        }
        const newDate = prompt("ØªØ¹Ø¯ÙŠÙ„ ØªØ§Ø±ÙŠØ® Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø·Ø§Ø±Ø¦Ø©:", item.date);
        if(newDate === null) return;
        if(!newDate.trim()){
          alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ±Ùƒ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙØ§Ø±ØºØ§Ù‹.");
          return;
        }
        const newCostStr = prompt("ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¨Ù„Øº Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø·Ø§Ø±Ø¦Ø© (IQD):", String(item.cost));
        if(newCostStr === null) return;
        const newCost = Number(newCostStr);
        if(isNaN(newCost) || newCost <= 0){
          alert("Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯Ø®Ù„ ØºÙŠØ± ØµØ§Ù„Ø­.");
          return;
        }
        const newNote = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):", item.note || "");
        if(newNote === null) return;

        item.date = newDate.trim();
        item.cost = newCost;
        item.note = newNote.trim();
      }

      if(action === "del-em"){
        if(!isAdmin()){
          alert("Ø­Ø°Ù Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø·Ø§Ø±Ø¦Ø© Ù…ØªØ§Ø­ Ù„Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø·.");
          return;
        }
        if(!confirm("Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø·Ø§Ø±Ø¦Ø©ØŸ")) return;
        emergencyMaintenances = emergencyMaintenances.filter(x=>x.id!==id);
      }

      renderEmergencyTable();
    });

    // ====== Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„ (Ø®Ø¯Ù…Ø© / Ù…ØµØ±ÙˆÙ / Ø­Ø°Ù) ======
    logBody.addEventListener("click", (e)=>{
      const btn = e.target.closest("button[data-action]");
      if(!btn) return;
      const action = btn.dataset.action;
      const d = btn.getAttribute("data-date");
      const m = Number(btn.getAttribute("data-meter"));
      const gen = state.generators.find(g=>g.id===selectedId);
      if(!gen) return;

      if(action === "del"){
        if(!isAdmin()){
          alert("Ø­Ø°Ù Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù…ØªØ§Ø­ Ù„Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø·.");
          return;
        }
        if(!confirm("Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©ØŸ")) return;
        gen.readings = (gen.readings||[]).filter(r=>!(r.date===d && Number(r.meter)===m));
      }

      if(action === "mark"){
        if(!isAdmin()){
          alert("ØªØ¹ÙŠÙŠÙ†/Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø®Ø¯Ù…Ø© Ù…ØªØ§Ø­ Ù„Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø·.");
          return;
        }
        if(!gen.serviceHistory) gen.serviceHistory = [];
        let svc = gen.serviceHistory.find(h=>h.date===d && Number(h.meter)===m);
        if(svc){
          if(confirm("Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù…Ø³Ø¬Ù„Ø© ÙƒØ®Ø¯Ù…Ø©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ø¥Ø´Ø§Ø±Ø© Ø§Ù„Ø®Ø¯Ù…Ø©ØŸ")){
            gen.serviceHistory = gen.serviceHistory.filter(h=>!(h.date===d && Number(h.meter)===m));
          }
        } else {
          if(confirm("ØªØ¹ÙŠÙŠÙ† Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙƒØ®Ø¯Ù…Ø© Ù…ÙƒØªÙ…Ù„Ø©ØŸ")){
            gen.serviceHistory.push({date:d, meter:m});
          }
        }
      }

      if(action === "expense"){
        if(!gen.serviceHistory) gen.serviceHistory = [];
        let svc = gen.serviceHistory.find(h=>h.date===d && Number(h.meter)===m);
        if(!svc){
          if(!isAdmin()){
            alert("Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø¯Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©ØŒ Ø§Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹.");
            return;
          }
          if(!confirm("Ù„Ù… ØªÙØ³Ø¬Ù‘Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙƒØ®Ø¯Ù…Ø© Ø¨Ø¹Ø¯. ØªØ¹ÙŠÙŠÙ†Ù‡Ø§ ÙƒØ®Ø¯Ù…Ø© Ø«Ù… Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙØŸ")) return;
          svc = {date:d, meter:m};
          gen.serviceHistory.push(svc);
        }

        const currentCost = svc.cost != null ? String(svc.cost) : "";
        const currentCurrency = svc.currency || "IQD";
        const currentNote = svc.costNote || "";

        const valCost = prompt("Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØµØ±ÙˆÙ (ÙŠÙ…ÙƒÙ† ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºÙ‹Ø§):", currentCost);
        if(valCost === null) return;
        const valCurrency = prompt("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ù…Ù„Ø© (IQD Ø£Ùˆ USD):", currentCurrency);
        if(valCurrency === null) return;
        const valNote = prompt("Ø£Ø¯Ø®Ù„ Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù„Ù…ØµØ±ÙˆÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):", currentNote);
        if(valNote === null) return;

        svc.cost = valCost.trim() ? Number(valCost.trim()) : null;
        svc.currency = valCurrency.trim().toUpperCase();
        svc.costNote = valNote.trim();
      }

      renderDetail();
      buildReports();
    });

    // ====== Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ======
    function parseRange(){
      let from = repFrom.value || "0000-01-01";
      let to   = repTo.value || "9999-12-31";
      return {from, to};
    }

    function buildSummaryReport(){
      const {from, to} = parseRange();
      const rows = [];

      state.generators.forEach(gen=>{
        const readings = (gen.readings||[]).filter(r=>r.date>=from && r.date<=to).sort(byDateAsc);
        let hours = 0;
        if(readings.length>=2){
          const first = readings[0];
          const last  = readings[readings.length-1];
          hours = Number(last.meter) - Number(first.meter);
        }

        let costIQD = 0;
        let costUSD = 0;
        const services = (gen.serviceHistory||[]).filter(s=>s.date>=from && s.date<=to);
        services.forEach(s=>{
          if(s.cost != null){
            if((s.currency||"").toUpperCase()==="USD") costUSD += Number(s.cost);
            else costIQD += Number(s.cost);
          }
        });

        rows.push({
          name:gen.name,
          hours,
          costIQD,
          costUSD,
          svcCount:services.length
        });
      });

      return rows;
    }

    function buildOverviewReport(){
      const {from, to} = parseRange();
      const rows = [];

      state.generators.forEach(gen=>{
        const readings = (gen.readings||[]).filter(r=>r.date>=from && r.date<=to).sort(byDateAsc);
        let hours = 0;
        if(readings.length>=2){
          const first = readings[0];
          const last  = readings[readings.length-1];
          hours = Number(last.meter) - Number(first.meter);
        }

        let costIQD = 0;
        const services = (gen.serviceHistory||[]).filter(s=>s.date>=from && s.date<=to);
        let lastServiceDate = "";
        services.forEach(s=>{
          if(s.cost != null){
            if((s.currency||"").toUpperCase()==="USD") return;
            costIQD += Number(s.cost);
          }
          if(!lastServiceDate || s.date>lastServiceDate){
            lastServiceDate = s.date;
          }
        });

        let avgPerHour = 0;
        if(hours>0){
          avgPerHour = costIQD / hours;
        }

        rows.push({
          name:gen.name,
          hours,
          costIQD,
          svcCount:services.length,
          avgPerHour,
          lastServiceDate
        });
      });

      return rows;
    }

    function buildExpensesReport(){
      const {from, to} = parseRange();
      const rows = [];
      state.generators.forEach(gen=>{
        (gen.serviceHistory||[]).forEach(s=>{
          if(s.date<from || s.date>to) return;
          if(s.cost == null) return;
          rows.push({
            gen:gen.name,
            date:s.date,
            meter:s.meter,
            cost:s.cost,
            currency:(s.currency||"").toUpperCase(),
            note:s.costNote||""
          });
        });
      });
      rows.sort((a,b)=> a.gen.localeCompare(b.gen) || a.date.localeCompare(b.date));
      return rows;
    }

    function renderSummaryReport(){
      const rows = buildSummaryReport();
      repSummaryBody.innerHTML = "";
      if(!rows.length){
        repSummaryBody.innerHTML = "<tr><td colspan='4' class='muted'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.</td></tr>";
        return;
      }
      let totalHours = 0;
      let totalIQD = 0;
      let totalSvc = 0;

      rows.forEach(r=>{
        totalHours += Number(r.hours) || 0;
        totalIQD += Number(r.costIQD) || 0;
        totalSvc += Number(r.svcCount) || 0;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.name}</td>
          <td>${r.hours}</td>
          <td>${r.costIQD}</td>
          <td>${r.svcCount}</td>
        `;
        repSummaryBody.appendChild(tr);
      });

      const totalRow = document.createElement("tr");
      totalRow.style.background = "#f9fafb";
      totalRow.style.fontWeight = "700";
      totalRow.innerHTML = `
        <td>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ</td>
        <td>${totalHours}</td>
        <td>${totalIQD}</td>
        <td>${totalSvc}</td>
      `;
      repSummaryBody.appendChild(totalRow);
    }

    function renderExpensesReport(){
      const rows = buildExpensesReport();
      repExpensesBody.innerHTML = "";
      if(!rows.length){
        repExpensesBody.innerHTML = "<tr><td colspan='6' class='muted'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ§Ø±ÙŠÙ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.</td></tr>";
        return;
      }
      rows.forEach(r=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.gen}</td>
          <td>${r.date}</td>
          <td>${r.meter}</td>
          <td>${r.cost}</td>
          <td>${r.currency}</td>
          <td>${r.note}</td>
        `;
        repExpensesBody.appendChild(tr);
      });
    }

    function renderOverviewReport(){
      const rows = buildOverviewReport();
      repOverviewBody.innerHTML = "";
      if(!rows.length){
        repOverviewBody.innerHTML = "<tr><td colspan='6' class='muted'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.</td></tr>";
        return;
      }

      let totalHours = 0;
      let totalIQD = 0;
      let totalSvc = 0;

      rows.forEach(r=>{
        totalHours += Number(r.hours) || 0;
        totalIQD += Number(r.costIQD) || 0;
        totalSvc += Number(r.svcCount) || 0;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.name}</td>
          <td>${r.hours}</td>
          <td>${r.costIQD}</td>
          <td>${r.svcCount}</td>
          <td>${r.avgPerHour ? r.avgPerHour.toFixed(2) : 0}</td>
          <td>${r.lastServiceDate || ""}</td>
        `;
        repOverviewBody.appendChild(tr);
      });

      const totalRow = document.createElement("tr");
      totalRow.style.background = "#f9fafb";
      totalRow.style.fontWeight = "700";
      const globalAvg = totalHours>0 ? (totalIQD/totalHours).toFixed(2) : 0;
      totalRow.innerHTML = `
        <td>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ</td>
        <td>${totalHours}</td>
        <td>${totalIQD}</td>
        <td>${totalSvc}</td>
        <td>${globalAvg}</td>
        <td></td>
      `;
      repOverviewBody.appendChild(totalRow);
    }

    function buildReports(){
      renderSummaryReport();
      renderOverviewReport();
      renderExpensesReport();
    }

    repRefresh.addEventListener("click", ()=>{
      buildReports();
    });

    // ====== ØªØµØ¯ÙŠØ± ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª CSV ======
    repCSV.addEventListener("click", ()=>{
      const activeTabBtn = document.querySelector(".tab-btn.active");
      const activeTab = activeTabBtn ? activeTabBtn.dataset.tab : "summary";
      const {from, to} = parseRange();

      let lines = [];
      lines.push(`Ø§Ù„ÙØªØ±Ø© Ù…Ù†: ${from === "0000-01-01" ? "Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©" : from} Ø¥Ù„Ù‰: ${to === "9999-12-31" ? "Ø§Ù„Ù†Ù‡Ø§ÙŠØ©" : to}`);

      if(activeTab === "summary"){
        const rows = buildSummaryReport();
        const header = ["Ø§Ù„Ù…ÙˆÙ„Ø¯","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ (IQD)","Ø¹Ø¯Ø¯ Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©"];
        lines.push(header.join(","));

        let totalHours = 0;
        let totalIQD = 0;
        let totalSvc = 0;

        rows.forEach(r=>{
          totalHours += Number(r.hours) || 0;
          totalIQD += Number(r.costIQD) || 0;
          totalSvc += Number(r.svcCount) || 0;

          lines.push([
            `"${String(r.name||"").replace(/"/g,'""')}"`,
            r.hours,
            r.costIQD,
            r.svcCount
          ].join(","));
        });

        lines.push([
          `"Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ"`,
          totalHours,
          totalIQD,
          totalSvc
        ].join(","));
      } else if(activeTab === "overview"){
        const rows = buildOverviewReport();
        const header = ["Ø§Ù„Ù…ÙˆÙ„Ø¯","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ (IQD)","Ø¹Ø¯Ø¯ Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©","Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙƒÙ„ÙØ© Ù„ÙƒÙ„ Ø³Ø§Ø¹Ø©","Ø¢Ø®Ø± ØªØ§Ø±ÙŠØ® ØµÙŠØ§Ù†Ø©"];
        lines.push(header.join(","));

        let totalHours = 0;
        let totalIQD = 0;
        let totalSvc = 0;

        rows.forEach(r=>{
          totalHours += Number(r.hours) || 0;
          totalIQD += Number(r.costIQD) || 0;
          totalSvc += Number(r.svcCount) || 0;

          lines.push([
            `"${String(r.name||"").replace(/"/g,'""')}"`,
            r.hours,
            r.costIQD,
            r.svcCount,
            r.avgPerHour ? r.avgPerHour.toFixed(2) : 0,
            `"${String(r.lastServiceDate||"").replace(/"/g,'""')}"`,
          ].join(","));
        });

        const globalAvg = totalHours>0 ? (totalIQD/totalHours).toFixed(2) : 0;
        lines.push([
          `"Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ"`,
          totalHours,
          totalIQD,
          totalSvc,
          globalAvg,
          ""
        ].join(","));
      } else {
        const rows = buildExpensesReport();
        const header = ["Ø§Ù„Ù…ÙˆÙ„Ø¯","ØªØ§Ø±ÙŠØ® Ø§Ù„Ø®Ø¯Ù…Ø©","Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯","Ø§Ù„Ù…Ø¨Ù„Øº","Ø§Ù„Ø¹Ù…Ù„Ø©","Ù…Ù„Ø§Ø­Ø¸Ø©"];
        lines.push(header.join(","));

        rows.forEach(r=>{
          lines.push([
            `"${String(r.gen||"").replace(/"/g,'""')}"`,
            r.date,
            r.meter,
            r.cost,
            r.currency,
            `"${String(r.note||"").replace(/"/g,'""')}"`,
          ].join(","));
        });
      }

      const csvContent = "\ufeff" + lines.join("\n");
      const blob = new Blob([csvContent],{type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      let fnameBase;
      if(activeTab === "summary") fnameBase = "generators-summary-report";
      else if(activeTab === "overview") fnameBase = "generators-overview-report";
      else fnameBase = "generators-expenses-report";
      a.href = url;
      a.download = fnameBase + ".csv";
      a.click();
      URL.revokeObjectURL(url);
    });

    // ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
    document.querySelectorAll(".tab-btn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        const tab = btn.dataset.tab;
        document.querySelectorAll(".report-tab").forEach(t=>t.style.display="none");
        if(tab==="summary") $("rep-summary").style.display = "";
        if(tab==="overview") $("rep-overview").style.display = "";
        if(tab==="expenses") $("rep-expenses").style.display = "";
      });
    });

    // ====== ØªØµØ¯ÙŠØ± / Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON ======
    expJSON.addEventListener("click", ()=>{
      if(!isAdmin()){
        alert("ØªØµØ¯ÙŠØ± JSON Ù…ØªØ§Ø­ Ù„Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø·.");
        return;
      }
      const fullData = {
        generators: state.generators,
        emergencyMaintenances
      };
      const blob = new Blob([JSON.stringify(fullData,null,2)],{type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "generator-system-data.json";
      a.click();
      URL.revokeObjectURL(url);
    });

    impJSON.addEventListener("change", (e)=>{
      if(!isAdmin()){
        alert("Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON Ù…ØªØ§Ø­ Ù„Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø·.");
        e.target.value = "";
        return;
      }
      const file = e.target.files?.[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const data = JSON.parse(String(reader.result));
          if(!data || !Array.isArray(data.generators)) throw new Error("Ø¨Ù†ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
          const mappedGenerators = data.generators.map((g,idx)=>({
            id: g.id || crypto.randomUUID(),
            name: g.name || ("Generator #"+(idx+1)),
            lastServiceMeter: Number(g.lastServiceMeter||0),
            lastServiceDate: g.lastServiceDate || todayStr(),
            readings: Array.isArray(g.readings) ? g.readings.map(r=>({date:r.date, meter:Number(r.meter)})) : [],
            serviceHistory: Array.isArray(g.serviceHistory) ? g.serviceHistory.map(h=>({
              date:h.date,
              meter:Number(h.meter),
              cost: h.cost != null ? Number(h.cost) : null,
              currency: h.currency || "IQD",
              costNote: h.costNote || ""
            })) : []
          }));
          state = { generators:mappedGenerators };
          emergencyMaintenances = normalizeEmergencyList(data.emergencyMaintenances);

          selectedId = state.generators[0]?.id || null;
          renderGenList();
          renderDetail();
          buildReports();
          renderEmergencyTable();
        }catch(err){
          alert("ØªØ¹Ø°Ø± Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù: " + (err.message||err));
        }
      };
      reader.readAsText(file);
    });

    // ====== Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ ======
    saveLocalBtn.addEventListener("click", ()=>{
      try{
        const fullData = {
          generators: state.generators,
          emergencyMaintenances
        };
        localStorage.setItem(LOCAL_KEY, JSON.stringify(fullData));
        alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¨Ù†Ø¬Ø§Ø­ âœ…");
      }catch(err){
        console.error("LocalStorage error", err);
        alert("ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ (Ø±Ø¨Ù…Ø§ Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† Ù…Ù…ØªÙ„Ø¦Ø©).");
      }
    });

    // ====== Ù…Ù„Ø®Øµ CSV Ø¨Ø³ÙŠØ· Ù…Ù† Ø§Ù„Ù‡ÙŠØ¯Ø± ======
    expCSV.addEventListener("click", ()=>{
      const header = ["Generator","Last Service Meter","Last Service Date","Current Meter","Hours Since Service","Next Due Meter","Status"];
      const lines = [header.join(",")];
      state.generators.forEach(gen=>{
        const cm = currentMeter(gen) ?? "";
        const since = hoursSinceService(gen);
        const next  = nextDueAt(gen);
        const st = statusObj(gen);
        lines.push([
          `"${(gen.name||"").replace(/"/g,'""')}"`,
          gen.lastServiceMeter ?? "",
          gen.lastServiceDate ?? "",
          cm,
          since,
          next,
          st.label
        ].join(","));
      });
      const blob = new Blob([lines.join("\n")],{type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "generators-quick-summary.csv";
      a.click();
      URL.revokeObjectURL(url);
    });

    // ====== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† LocalStorage Ø£Ùˆ Ù…Ù† generators.json ======
    async function loadInitialData(){
      try {
        const stored = localStorage.getItem(LOCAL_KEY);
        if (stored) {
          try {
            const data = JSON.parse(stored);
            if (data && Array.isArray(data.generators)) {
              state = {
                generators: data.generators.map((g, idx) => ({
                  id: g.id || crypto.randomUUID(),
                  name: g.name || ("Generator #" + (idx + 1)),
                  lastServiceMeter: Number(g.lastServiceMeter || 0),
                  lastServiceDate: g.lastServiceDate || todayStr(),
                  readings: Array.isArray(g.readings) ? g.readings.map(r => ({
                    date: r.date,
                    meter: Number(r.meter)
                  })) : [],
                  serviceHistory: Array.isArray(g.serviceHistory) ? g.serviceHistory.map(h => ({
                    date: h.date,
                    meter: Number(h.meter),
                    cost: h.cost != null ? Number(h.cost) : null,
                    currency: h.currency || "IQD",
                    costNote: h.costNote || ""
                  })) : []
                }))
              };
              emergencyMaintenances = normalizeEmergencyList(data.emergencyMaintenances);

              selectedId = state.generators[0]?.id || null;
              renderGenList();
              renderDetail();
              buildReports();
              renderEmergencyTable();
              console.log("Loaded data from localStorage");
              return;
            }
          } catch(e){
            console.warn("ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ù„Ù JSON", e);
          }
        }

        const res = await fetch("generators.json");
        if (!res.ok) {
          console.warn("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù generators.json");
          return;
        }

        const data = await res.json();

        if (!data || !Array.isArray(data.generators)) {
          console.warn("ØµÙŠØºØ© Ù…Ù„Ù JSON ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
          return;
        }

        state = {
          generators: data.generators.map((g, idx) => ({
            id: g.id || crypto.randomUUID(),
            name: g.name || ("Generator #" + (idx + 1)),
            lastServiceMeter: Number(g.lastServiceMeter || 0),
            lastServiceDate: g.lastServiceDate || todayStr(),
            readings: Array.isArray(g.readings) ? g.readings.map(r => ({
              date: r.date,
              meter: Number(r.meter)
            })) : [],
            serviceHistory: Array.isArray(g.serviceHistory) ? g.serviceHistory.map(h => ({
              date: h.date,
              meter: Number(h.meter),
              cost: h.cost != null ? Number(h.cost) : null,
              currency: h.currency || "IQD",
              costNote: h.costNote || ""
            })) : []
          }))
        };
        emergencyMaintenances = normalizeEmergencyList(data.emergencyMaintenances);

        selectedId = state.generators[0]?.id || null;
        renderGenList();
        renderDetail();
        buildReports();
        renderEmergencyTable();
        console.log("Loaded data from generators.json");
      } catch (err) {
        console.error("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", err);
      }
    }

    // ====== ØªÙ‡ÙŠØ¦Ø© Ø£ÙˆÙ„ÙŠØ© ======
    (function init(){
      genDate.value = todayStr();
      repFrom.value = "";
      repTo.value   = "";
      renderGenList();
      renderDetail();
      buildReports();
      renderEmergencyGeneratorOptions();
      renderEmergencyTable();
      loadInitialData();
    })();

    // ====== Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¹Ø¯ Ø§Ù„Ø±ÙŠÙØ±ÙŠØ´ ======
    (function restoreUserSession(){
      try{
        const stored = localStorage.getItem(USER_STORAGE_KEY);
        if(!stored) return;

        const parsed = JSON.parse(stored);

        // Ù†ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø§ Ø²Ø§Ù„ Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© USERS
        const match = USERS.find(u => u.username === parsed.username && u.role === parsed.role);
        if(!match) return;

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        currentUser = {username: match.username, role: match.role};

        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙˆØ¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
        loginScreen.style.display = "none";
        appRoot.style.display = "block";

        // ØªÙØ¹ÙŠÙ„ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
        applyRoleUI();

      }catch(e){
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…", e);
      }
    })();

  </script>
</body>
</html>
