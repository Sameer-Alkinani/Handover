<script>
  // Simple admin flag
  const IS_ADMIN = true;
  const MAX_ATTACHMENT_SIZE = 3 * 1024 * 1024; // ~3MB

  // ===== Data & Storage =====
  const defaultUsers = [
    { name: "Sameer Jabbar",       role: "Manager",    email: "sameer_jabbar@yahoo.com" },
    { name: "Ardasher A. Ahmad",   role: "Supervisor", email: "" },
  ];

  const defaultHandovers = [
    {
      id: "HNDR-001",
      from: "Sameer Jabbar",
      to: "Ardasher A. Ahmad",
      items: "120 cartons of Product A",
      longDescription: "",
      status: "Pending",
      date: "2025-11-20",
      actionBy: "Sameer Jabbar",
      attachmentName: null,
      attachmentType: null,
      attachmentSize: null,
      attachmentDataUrl: null,
    },
    {
      id: "HNDR-002",
      from: "Sameer Jabbar",
      to: "Ardasher A. Ahmad",
      items: "45 pallets of Product B",
      longDescription: "",
      status: "Completed",
      date: "2025-11-21",
      actionBy: "Sameer Jabbar",
      attachmentName: null,
      attachmentType: null,
      attachmentSize: null,
      attachmentDataUrl: null,
    },
  ];

  const defaultAccounts = [
    {
      username: "admin",
      employeeName: "Sameer Jabbar",
      role: "Admin",
      status: "Active",
    },
  ];

  let users = [];
  let handovers = [];
  let filteredHandovers = [];
  let accounts = [];

  function saveUsers() {
    localStorage.setItem("warehouseUsers", JSON.stringify(users));
  }

  function loadUsers() {
    const stored = localStorage.getItem("warehouseUsers");
    if (stored) {
      try {
        users = JSON.parse(stored);
      } catch {
        users = [...defaultUsers];
      }
    } else {
      users = [...defaultUsers];
    }
  }

  function saveHandovers() {
    localStorage.setItem("warehouseHandovers", JSON.stringify(handovers));
  }

  function loadHandovers() {
    const stored = localStorage.getItem("warehouseHandovers");
    if (stored) {
      try {
        handovers = JSON.parse(stored);
      } catch {
        handovers = [...defaultHandovers];
      }
    } else {
      handovers = [...defaultHandovers];
    }
    filteredHandovers = [...handovers];
  }

  function saveAccounts() {
    localStorage.setItem("warehouseAccounts", JSON.stringify(accounts));
  }

  function loadAccounts() {
    const stored = localStorage.getItem("warehouseAccounts");
    if (stored) {
      try {
        accounts = JSON.parse(stored);
      } catch {
        accounts = [...defaultAccounts];
      }
    } else {
      accounts = [...defaultAccounts];
    }
  }

  // ===== Utilities =====
  function createElement(tag, className, text) {
    const el = document.createElement(tag);
    if (className) el.className = className;
    if (text) el.textContent = text;
    return el;
  }

  function formatDate(dateStr) {
    if (!dateStr) return "";
    const d = new Date(dateStr);
    if (isNaN(d.getTime())) return dateStr;
    return d.toLocaleDateString("en-GB", {
      year: "numeric",
      month: "short",
      day: "2-digit",
    });
  }

  function generateId(prefix = "HNDR") {
    const num = handovers.length + 1;
    return `${prefix}-${String(num).padStart(3, "0")}`;
  }

  function setActiveView(viewName, persist = true) {
    document
      .querySelectorAll(".sidebar-item")
      .forEach((item) => item.classList.remove("active"));

    const activeSidebarItem = document.querySelector(
      `.sidebar-item[data-view="${viewName}"]`
    );
    if (activeSidebarItem) {
      activeSidebarItem.classList.add("active");
    }

    document
      .querySelectorAll(".view-section")
      .forEach((sec) => sec.classList.add("d-none"));
    const viewSection = document.querySelector(
      `.view-section[data-view="${viewName}"]`
    );
    if (viewSection) {
      viewSection.classList.remove("d-none");
    }

    if (persist) {
      localStorage.setItem("warehouseActiveView", viewName);
    }

    if (viewName === "reports") {
      renderReports();
    }
  }

  // ===== Sidebar Navigation =====
  function initSidebarNavigation() {
    document.querySelectorAll(".sidebar-item").forEach((item) => {
      item.addEventListener("click", () => {
        const view = item.getAttribute("data-view");
        setActiveView(view);
      });
    });

    const logo = document.getElementById("sidebar-logo");
    if (logo) {
      logo.addEventListener("click", () => setActiveView("dashboard"));
    }
  }

  // ===== Users Management =====
  const usersTableBody = document.getElementById("users-table-body");
  const userForm = document.getElementById("user-form");
  const userNameInput = document.getElementById("user-name");
  const userRoleInput = document.getElementById("user-role");
  const userEmailInput = document.getElementById("user-email");
  const userModal = new bootstrap.Modal(
    document.getElementById("userModal"),
    {}
  );
  const userModalTitle = document.getElementById("userModalLabel");
  let isEditUser = false;
  let editingUserIndex = null;

  function renderUsers() {
    if (!usersTableBody) return;
    usersTableBody.innerHTML = "";
    if (!users || users.length === 0) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 4;
      td.className = "text-center text-muted";
      td.textContent = "No users found. Please add a user.";
      tr.appendChild(td);
      usersTableBody.appendChild(tr);
      return;
    }

    users.forEach((u, index) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${u.name || ""}</td>
        <td>${u.role || ""}</td>
        <td>${u.email || ""}</td>
        <td>
          <button class="btn btn-sm btn-outline-secondary me-1" data-index="${index}">
            Edit
          </button>
          <button class="btn btn-sm btn-outline-danger" data-index="${index}">
            Delete
          </button>
        </td>
      `;
      const [editBtn, deleteBtn] = tr.querySelectorAll("button");

      editBtn.addEventListener("click", () => {
        isEditUser = true;
        editingUserIndex = index;
        userModalTitle.textContent = "Edit User";
        userNameInput.value = u.name || "";
        userRoleInput.value = u.role || "";
        userEmailInput.value = u.email || "";
        userModal.show();
      });

      deleteBtn.addEventListener("click", () => {
        if (
          confirm(
            `Are you sure you want to delete user "${u.name || "Unnamed"}"?`
          )
        ) {
          users.splice(index, 1);
          saveUsers();
          renderUsers();
          refreshUserSelectOptions();
        }
      });

      usersTableBody.appendChild(tr);
    });
  }

  function initUserModal() {
    const btnAddUser = document.getElementById("btn-add-user");
    if (!btnAddUser) return;

    btnAddUser.addEventListener("click", () => {
      isEditUser = false;
      editingUserIndex = null;
      userModalTitle.textContent = "Add User";
      userForm.reset();
      userModal.show();
    });

    userForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const name = userNameInput.value.trim();
      const role = userRoleInput.value.trim();
      const email = userEmailInput.value.trim();

      if (!name) {
        alert("Name is required");
        return;
      }

      const newUser = { name, role, email };

      if (isEditUser && editingUserIndex !== null) {
        users[editingUserIndex] = newUser;
      } else {
        users.push(newUser);
      }

      saveUsers();
      renderUsers();
      refreshUserSelectOptions();
      userModal.hide();
    });
  }

  function initUserForm() {
    if (!userForm) return;
  }

  function refreshUserSelectOptions() {
    const selectFields = [
      document.getElementById("handover-from"),
      document.getElementById("handover-to"),
      document.getElementById("handover-action-by"),
      document.getElementById("account-employee"),
      document.getElementById("filter-user"),
    ];

    const userNames = users.map((u) => u.name).filter(Boolean);
    selectFields.forEach((select) => {
      if (!select) return;
      const currentValue = select.value;
      select.innerHTML = '<option value="">-- Select --</option>';
      userNames.forEach((name) => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        select.appendChild(opt);
      });
      if (currentValue && userNames.includes(currentValue)) {
        select.value = currentValue;
      }
    });
  }

  // ===== Handovers Table =====
  const tableBody = document.getElementById("handover-table-body");
  const noDataRow = document.getElementById("no-data-row");

  function renderTable() {
    if (!tableBody) return;
    tableBody.innerHTML = "";

    if (!filteredHandovers || filteredHandovers.length === 0) {
      if (noDataRow) noDataRow.style.display = "";
      return;
    }

    if (noDataRow) noDataRow.style.display = "none";

    filteredHandovers.forEach((h) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${h.id || ""}</td>
        <td>${h.from || ""}</td>
        <td>${h.to || ""}</td>
        <td>${h.items || ""}</td>
        <td>${h.status || ""}</td>
        <td>${formatDate(h.date)}</td>
        <td>${h.actionBy || ""}</td>
        <td>
          <button class="btn btn-sm btn-outline-secondary btn-view" data-id="${h.id}">
            View
          </button>
        </td>
      `;
      const btnView = tr.querySelector(".btn-view");
      btnView.addEventListener("click", () => openViewHandoverModal(h.id));
      tableBody.appendChild(tr);
    });
  }

  function applyFilters() {
    const fromDate = document.getElementById("filter-from").value;
    const toDate = document.getElementById("filter-to").value;
    const status = document.getElementById("filter-status").value;
    const userValue = document.getElementById("filter-user").value;
    const dateFrom = document.getElementById("filter-date-from").value;
    const searchText = document
      .getElementById("filter-search")
      .value.toLowerCase()
      .trim();

    filteredHandovers = handovers.filter((h) => {
      let ok = true;

      if (fromDate) {
        ok = ok && h.date >= fromDate;
      }
      if (toDate) {
        ok = ok && h.date <= toDate;
      }
      if (dateFrom) {
        ok = ok && h.date >= dateFrom;
      }
      if (status) {
        ok = ok && h.status === status;
      }
      if (userValue) {
        ok = ok && (h.actionBy === userValue || h.from === userValue || h.to === userValue);
      }
      if (searchText) {
        const textCombined = `${h.id} ${h.from} ${h.to} ${h.items} ${h.status} ${h.actionBy}`
          .toLowerCase();
        ok = ok && textCombined.includes(searchText);
      }
      return ok;
    });

    renderTable();
    renderReports();
  }

  function resetFilters() {
    document.getElementById("filter-from").value = "";
    document.getElementById("filter-to").value = "";
    document.getElementById("filter-status").value = "";
    document.getElementById("filter-user").value = "";
    document.getElementById("filter-date-from").value = "";
    document.getElementById("filter-search").value = "";

    filteredHandovers = [...handovers];
    renderTable();
    renderReports();
  }

  // ===== Handover Modal =====
  const handoverModalEl = document.getElementById("handoverModal");
  const handoverModal = new bootstrap.Modal(handoverModalEl, {});
  const handoverForm = document.getElementById("handover-form");
  const handoverIdField = document.getElementById("handover-id");
  const handoverFromField = document.getElementById("handover-from");
  const handoverToField = document.getElementById("handover-to");
  const handoverItemsField = document.getElementById("handover-items");
  const handoverLongDescField = document.getElementById("handover-long-desc");
  const handoverStatusField = document.getElementById("handover-status");
  const handoverDateField = document.getElementById("handover-date");
  const handoverActionByField = document.getElementById("handover-action-by");
  const attachmentInput = document.getElementById("handover-attachment");
  const attachmentPreview = document.getElementById("handover-attachment-preview");
  const attachmentInfoText = document.getElementById("handover-attachment-info");
  const btnAddHandover = document.getElementById("btn-add-handover");
  const btnDownloadAttachment = document.getElementById("btn-download-attachment");

  let editingHandoverId = null;

  function initHandoverModal() {
    if (!btnAddHandover) return;

    btnAddHandover.addEventListener("click", () => {
      editingHandoverId = null;
      handoverForm.reset();
      attachmentPreview.innerHTML = "";
      attachmentInfoText.textContent = "";
      document.getElementById("handoverModalLabel").textContent =
        "New Handover";
      handoverIdField.value = generateId("HNDR");
      handoverDateField.value = new Date().toISOString().slice(0, 10);
      handoverStatusField.value = "Pending";
      handoverModal.show();
    });

    handoverForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = {
        id: handoverIdField.value.trim() || generateId("HNDR"),
        from: handoverFromField.value || "",
        to: handoverToField.value || "",
        items: handoverItemsField.value || "",
        longDescription: handoverLongDescField.value || "",
        status: handoverStatusField.value || "Pending",
        date: handoverDateField.value || new Date().toISOString().slice(0, 10),
        actionBy: handoverActionByField.value || "",
        attachmentName: null,
        attachmentType: null,
        attachmentSize: null,
        attachmentDataUrl: null,
      };

      const file = attachmentInput.files[0];
      if (file) {
        if (file.size > MAX_ATTACHMENT_SIZE) {
          alert("Attachment is too large. Please select a file under 3MB.");
          return;
        }
        const reader = new FileReader();
        reader.onload = function (evt) {
          data.attachmentName = file.name;
          data.attachmentType = file.type;
          data.attachmentSize = file.size;
          data.attachmentDataUrl = evt.target.result;
          saveHandoverData(data);
        };
        reader.readAsDataURL(file);
      } else {
        saveHandoverData(data);
      }
    });

    attachmentInput.addEventListener("change", () => {
      const file = attachmentInput.files[0];
      if (!file) {
        attachmentPreview.innerHTML = "";
        attachmentInfoText.textContent = "";
        return;
      }

      if (file.size > MAX_ATTACHMENT_SIZE) {
        alert("Attachment is too large. Please select a file under 3MB.");
        attachmentInput.value = "";
        attachmentPreview.innerHTML = "";
        attachmentInfoText.textContent = "";
        return;
      }

      attachmentInfoText.textContent = `${file.name} (${(file.size / 1024).toFixed(1)} KB)`;

      if (file.type.startsWith("image/")) {
        const img = document.createElement("img");
        img.className = "img-fluid mt-2 rounded border";
        img.style.maxHeight = "240px";
        const reader = new FileReader();
        reader.onload = (evt) => {
          img.src = evt.target.result;
        };
        reader.readAsDataURL(file);
        attachmentPreview.innerHTML = "";
        attachmentPreview.appendChild(img);
      } else {
        attachmentPreview.innerHTML = "";
      }
    });
  }

  function saveHandoverData(data) {
    if (editingHandoverId) {
      const index = handovers.findIndex((h) => h.id === editingHandoverId);
      if (index !== -1) {
        handovers[index] = data;
      }
    } else {
      handovers.push(data);
    }

    saveHandovers();
    filteredHandovers = [...handovers];
    renderTable();
    renderReports();
    handoverModal.hide();
  }

  function openViewHandoverModal(id) {
    const h = handovers.find((x) => x.id === id);
    if (!h) return;

    editingHandoverId = id;

    document.getElementById("handoverModalLabel").textContent =
      "View / Edit Handover";

    handoverIdField.value = h.id || "";
    handoverFromField.value = h.from || "";
    handoverToField.value = h.to || "";
    handoverItemsField.value = h.items || "";
    handoverLongDescField.value = h.longDescription || "";
    handoverStatusField.value = h.status || "Pending";
    handoverDateField.value = h.date || "";
    handoverActionByField.value = h.actionBy || "";

    attachmentInput.value = "";
    attachmentPreview.innerHTML = "";
    attachmentInfoText.textContent = "";

    if (h.attachmentName && h.attachmentDataUrl) {
      attachmentInfoText.textContent = `${h.attachmentName} (${h.attachmentSize ? (h.attachmentSize / 1024).toFixed(1) + " KB" : ""})`;

      if (h.attachmentType && h.attachmentType.startsWith("image/")) {
        const img = document.createElement("img");
        img.className = "img-fluid mt-2 rounded border";
        img.style.maxHeight = "240px";
        img.src = h.attachmentDataUrl;
        attachmentPreview.appendChild(img);
      }
      if (btnDownloadAttachment) {
        btnDownloadAttachment.classList.remove("d-none");
        btnDownloadAttachment.onclick = () =>
          downloadAttachment(h.attachmentName, h.attachmentDataUrl);
      }
    } else {
      if (btnDownloadAttachment) {
        btnDownloadAttachment.classList.add("d-none");
      }
    }

    handoverModal.show();
  }

  function downloadAttachment(fileName, dataUrl) {
    const a = document.createElement("a");
    a.href = dataUrl;
    a.download = fileName || "attachment";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }

  // ===== Dashboard Stats & Charts =====
  function renderReports() {
    const totalSpan = document.getElementById("rep-total");
    const completedSpan = document.getElementById("rep-completed");
    const pendingSpan = document.getElementById("rep-pending");
    const delayedSpan = document.getElementById("rep-delayed");

    const total = handovers.length;
    const completed = handovers.filter((h) => h.status === "Completed").length;
    const pending = handovers.filter((h) => h.status === "Pending").length;
    const delayed = handovers.filter((h) => h.status === "Delayed").length;

    if (totalSpan) totalSpan.textContent = total;
    if (completedSpan) completedSpan.textContent = completed;
    if (pendingSpan) pendingSpan.textContent = pending;
    if (delayedSpan) delayedSpan.textContent = delayed;

    const statusCtx = document
      .getElementById("statusChart")
      ?.getContext("2d");
    const userCtx = document
      .getElementById("userChart")
      ?.getContext("2d");

    if (!statusCtx || !userCtx) return;

    const statusCounts = {
      Pending: pending,
      Completed: completed,
      Delayed: delayed,
    };

    const countsByUser = {};
    handovers.forEach((h) => {
      const key = h.actionBy || h.from || "Unknown";
      countsByUser[key] = (countsByUser[key] || 0) + 1;
    });

    if (window.statusChartInstance) {
      window.statusChartInstance.destroy();
    }
    if (window.userChartInstance) {
      window.userChartInstance.destroy();
    }

    window.statusChartInstance = new Chart(statusCtx, {
      type: "pie",
      data: {
        labels: Object.keys(statusCounts),
        datasets: [
          {
            data: Object.values(statusCounts),
          },
        ],
      },
      options: {
        plugins: {
          legend: {
            position: "bottom",
          },
        },
      },
    });

    window.userChartInstance = new Chart(userCtx, {
      type: "bar",
      data: {
        labels: Object.keys(countsByUser),
        datasets: [
          {
            data: Object.values(countsByUser),
          },
        ],
      },
      options: {
        plugins: {
          legend: {
            display: false,
          },
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 1,
            },
          },
        },
      },
    });
  }

  // ===== Accounts Management =====
  const accountTableBody = document.getElementById("accounts-table-body");
  const accountForm = document.getElementById("account-form");
  const accountUsernameInput = document.getElementById("account-username");
  const accountEmployeeSelect = document.getElementById("account-employee");
  const accountRoleSelect = document.getElementById("account-role");
  const accountStatusSelect = document.getElementById("account-status");
  const accountModal = new bootstrap.Modal(
    document.getElementById("accountModal"),
    {}
  );
  const accountModalTitle = document.getElementById("accountModalLabel");
  let isEditAccount = false;
  let editingAccountIndex = null;

  function fillAccountEmployeeOptions() {
    if (!accountEmployeeSelect) return;
    const current = accountEmployeeSelect.value;
    accountEmployeeSelect.innerHTML =
      '<option value="">-- Select employee --</option>';
    users.forEach((u) => {
      const opt = document.createElement("option");
      opt.value = u.name;
      opt.textContent = u.name;
      accountEmployeeSelect.appendChild(opt);
    });
    if (current) accountEmployeeSelect.value = current;
  }

  function renderAccounts() {
    if (!accountTableBody) return;
    accountTableBody.innerHTML = "";

    if (!accounts || accounts.length === 0) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 5;
      td.className = "text-center text-muted";
      td.textContent = "No accounts found. Please add an account.";
      tr.appendChild(td);
      accountTableBody.appendChild(tr);
      return;
    }

    accounts.forEach((acc, index) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${acc.username || ""}</td>
        <td>${acc.employeeName || ""}</td>
        <td>${acc.role || ""}</td>
        <td>${acc.status || ""}</td>
        <td>
          <button class="btn btn-sm btn-outline-secondary me-1" data-index="${index}">
            Edit
          </button>
          <button class="btn btn-sm btn-outline-danger" data-index="${index}">
            Delete
          </button>
        </td>
      `;
      const [editBtn, deleteBtn] = tr.querySelectorAll("button");

      editBtn.addEventListener("click", () => {
        isEditAccount = true;
        editingAccountIndex = index;
        accountModalTitle.textContent = "Edit Account";
        accountUsernameInput.value = acc.username;
        accountEmployeeSelect.value = acc.employeeName || "";
        accountRoleSelect.value = acc.role || "User";
        accountStatusSelect.value = acc.status || "Active";
        accountModal.show();
      });

      deleteBtn.addEventListener("click", () => {
        if (
          confirm(
            `Are you sure you want to delete account "${acc.username || ""}"?`
          )
        ) {
          accounts.splice(index, 1);
          saveAccounts();
          renderAccounts();
        }
      });

      accountTableBody.appendChild(tr);
    });
  }

  function initAccountModal() {
    const btnAdd = document.getElementById("btn-add-account");
    if (!btnAdd || !accountForm) return;

    btnAdd.addEventListener("click", () => {
      isEditAccount = false;
      editingAccountIndex = null;
      accountForm.reset();
      fillAccountEmployeeOptions();
      accountStatusSelect.value = "Active";
      accountModal.show();
    });

    accountForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const username = accountUsernameInput.value.trim();
      const employeeName = accountEmployeeSelect.value || "";
      const role = accountRoleSelect.value || "User";
      const status = accountStatusSelect.value || "Active";

      if (!username) {
        alert("Username is required");
        return;
      }
      if (!employeeName) {
        alert("Employee is required");
        return;
      }

      const newAccount = {
        username,
        employeeName,
        role,
        status,
      };

      if (isEditAccount && editingAccountIndex !== null) {
        accounts[editingAccountIndex] = newAccount;
      } else {
        accounts.push(newAccount);
      }

      saveAccounts();
      renderAccounts();
      accountModal.hide();
    });
  }

  // ===== Admin Tools (Export / Import / Clear) =====
  function initAdminTools() {
    const adminTools = document.getElementById("admin-tools");
    if (!adminTools) return;

    // If user is not admin, hide the whole group
    if (!IS_ADMIN) {
      adminTools.classList.add("d-none");
      return;
    }

    initExportJson();
    initImportJson();
    initClearData();
  }

  // ===== Export JSON =====
  function initExportJson() {
    const btn = document.getElementById("btn-export-json");
    if (!btn) return;
    btn.addEventListener("click", () => {
      const data = {
        exportedAt: new Date().toISOString(),
        handovers,
        users,
        accounts,
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], {
        type: "application/json",
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const dateStr = new Date().toISOString().slice(0, 10);
      a.href = url;
      a.download = `warehouse-data-${dateStr}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });
  }

  // ===== Import JSON =====
  function initImportJson() {
    const btnImport = document.getElementById("btn-import-json");
    const inputImport = document.getElementById("input-import-json");
    if (!btnImport || !inputImport) return;

    btnImport.addEventListener("click", () => {
      inputImport.click();
    });

    inputImport.addEventListener("change", async () => {
      const file = inputImport.files[0];
      if (!file) return;

      try {
        const text = await file.text();
        const data = JSON.parse(text);

        if (
          !data ||
          !Array.isArray(data.handovers) ||
          !Array.isArray(data.users) ||
          !Array.isArray(data.accounts)
        ) {
          alert("Invalid JSON file format. Expected keys: handovers, users, accounts.");
          inputImport.value = "";
          return;
        }

        handovers = data.handovers;
        users = data.users;
        accounts = data.accounts;

        saveHandovers();
        saveUsers();
        saveAccounts();

        filteredHandovers = [...handovers];
        renderUsers();
        refreshUserSelectOptions();
        renderAccounts();
        resetFilters();
        renderReports();

        alert("JSON data imported successfully.");
      } catch (err) {
        console.error(err);
        alert("Error reading or parsing JSON file.");
      } finally {
        inputImport.value = "";
      }
    });
  }

  // ===== Clear All Data =====
  function initClearData() {
    const btnClear = document.getElementById("btn-clear-data");
    if (!btnClear) return;

    btnClear.addEventListener("click", () => {
      const ok = confirm(
        "This will delete ALL handovers, users and accounts from this browser. Are you sure?"
      );
      if (!ok) return;

      localStorage.removeItem("warehouseHandovers");
      localStorage.removeItem("warehouseUsers");
      localStorage.removeItem("warehouseAccounts");

      handovers = [];
      filteredHandovers = [];
      users = [];
      accounts = [];

      renderUsers();
      refreshUserSelectOptions();
      renderAccounts();
      renderTable();
      renderReports();

      alert("All local data has been cleared.");
    });
  }

  // ===== DOMContentLoaded =====
  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("top-date").value =
      new Date().toISOString().slice(0, 10);

    document
      .getElementById("btn-today")
      .addEventListener("click", () => resetFilters());

    document
      .getElementById("filter-from")
      .addEventListener("change", applyFilters);
    document
      .getElementById("filter-to")
      .addEventListener("change", applyFilters);
    document
      .getElementById("filter-status")
      .addEventListener("change", applyFilters);
    document
      .getElementById("filter-date-from")
      .addEventListener("change", applyFilters);
    document
      .getElementById("filter-search")
      .addEventListener("input", applyFilters);

    document
      .getElementById("btn-reset-filters")
      .addEventListener("click", resetFilters);

    loadUsers();
    loadHandovers();
    loadAccounts();

    initSidebarNavigation();
    initUserForm();
    initUserModal();
    renderUsers();

    initHandoverModal();
    initAccountModal();

    refreshUserSelectOptions();
    renderTable();
    renderAccounts();
    initAdminTools();

    const savedView = localStorage.getItem("warehouseActiveView") || "dashboard";
    setActiveView(savedView, false);
  });
</script>
